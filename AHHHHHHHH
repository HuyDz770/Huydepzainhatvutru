--[[
    ZERAA HUB - RACE V4 ULTIMATE [MARU BYPASS INTEGRATED]
    Updated: 28/01/2026
    
    [TÍNH NĂNG ĐẦY ĐỦ]
    1. MARU ANTI-BAN: Gửi gói tin giả lập Mobile liên tục (OnEventServiceUpdate).
    2. HELPER SYNC: Acc phụ tự động bám đuôi và bật tộc V3/V4 CÙNG LÚC với Acc chính.
    3. MAP LOAD FIX: Cơ chế Anchor + RequestStream để lên ToT không bị rơi.
    4. AUTO TRAIN: Treo cứng trên trời, không bị kick, tự đánh giữ nộ.
    5. AUTO TRIAL: Full logic cho mọi tộc (Human, Ghoul, Shark, Sky, Mink, Cyborg).
]]

-- // 1. CẤU HÌNH (QUAN TRỌNG: ĐIỀN TÊN ACC CHÍNH) //
_G.Settings = {
    MainAccount = "Ten_Nick_Chinh_Cua_Ban", -- Điền CHÍNH XÁC tên acc chính vào đây
    TweenSpeed = 300,
    HelperDistance = 10,   -- Khoảng cách acc phụ đứng cạnh acc chính
    SpamSkill = true       -- Tự động spam skill khi trial/train
}

-- // 2. SERVICES //
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local VirtualUser = game:GetService("VirtualUser")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local LocalPlayer = Players.LocalPlayer

-- // 3. MARU ANTI-BAN SYSTEM (VÒNG LẶP LIÊN TỤC) //
-- Đây là đoạn code bạn yêu cầu, được đưa vào loop để chạy ngầm liên tục
spawn(function()
    while task.wait(10) do -- Gửi gói tin mỗi 10 giây để duy trì session
        pcall(function()
            local args = {
                {},
                false,
                "en-gb",
                "Mobile",
                Vector2.new(1600, 900),
                false,
                1
            }
            local remote = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("OnEventServiceUpdate")
            if remote then
                remote:FireServer(unpack(args))
            end
        end)
    end
end)

-- Anti-AFK (Bổ trợ)
LocalPlayer.Idled:Connect(function()
    VirtualUser:CaptureController()
    VirtualUser:Button2Down(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
    task.wait(1)
    VirtualUser:Button2Up(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
end)

-- // 4. CORE FUNCTIONS //

local function getHRP()
    return LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
end

local function Notify(content)
    game:GetService("StarterGui"):SetCore("SendNotification", {
        Title = "Zeraa V4 Ultimate",
        Text = content,
        Duration = 3
    })
end

-- Fix Attack (VirtualUser Button1Down)
local function SafeAttack()
    pcall(function()
        if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
            VirtualUser:CaptureController()
            VirtualUser:Button1Down(Vector2.new(1280, 672))
            
            -- Hỗ trợ thêm remote để chắc ăn
            local net = ReplicatedStorage.Modules.Net
            if net:FindFirstChild("RegisterAttack") then 
                net["RegisterAttack"]:FireServer(0) 
            end
        end
    end)
end

-- Hàm gửi phím (Hỗ trợ cả VirtualUser và VirtualInputManager)
local function SendKey(key)
    spawn(function()
        pcall(function()
            VirtualInputManager:SendKeyEvent(true, Enum.KeyCode[key], false, game)
            task.wait(0.05)
            VirtualInputManager:SendKeyEvent(false, Enum.KeyCode[key], false, game)
        end)
    end)
end

local function EquipWeapon()
    pcall(function()
        for _, v in pairs(LocalPlayer.Backpack:GetChildren()) do
            if v:IsA("Tool") and v.ToolTip == "Melee" then
                LocalPlayer.Character.Humanoid:EquipTool(v)
            end
        end
    end)
end

-- Fix Map Load (Chống rơi vực khi lên ToT)
local function ForceLoadMap(targetPos)
    local hrp = getHRP()
    if not hrp then return end
    
    Notify("Đang tải map Temple of Time...")
    
    -- Neo nhân vật lại
    hrp.Anchored = true
    hrp.CFrame = CFrame.new(targetPos)
    
    -- Spam request load map
    for i = 1, 5 do
        LocalPlayer:RequestStreamAroundAsync(targetPos)
        ReplicatedStorage.Remotes.CommF_:InvokeServer("requestEntrance", targetPos)
        task.wait(0.5)
    end
    
    -- Kiểm tra xem có sàn nhà chưa
    local loaded = false
    local timeout = 0
    repeat
        task.wait(0.5)
        timeout = timeout + 0.5
        local ray = Ray.new(hrp.Position, Vector3.new(0, -30, 0))
        local hit, _ = Workspace:FindPartOnRay(ray, LocalPlayer.Character)
        if hit then loaded = true end
    until loaded or timeout > 10
    
    hrp.Anchored = false
    Notify("Map đã tải xong!")
end

local function SmartMove(targetCFrame)
    if not targetCFrame then return end
    local hrp = getHRP()
    if not hrp then return end

    -- Tắt va chạm để bay mượt
    for _, v in pairs(LocalPlayer.Character:GetDescendants()) do
        if v:IsA("BasePart") then v.CanCollide = false end
    end

    local dist = (hrp.Position - targetCFrame.Position).Magnitude
    
    -- Nếu khoảng cách quá xa (từ biển lên trời), dùng ForceLoadMap
    if dist > 3000 then
        ForceLoadMap(targetCFrame.Position)
    else
        -- Bay thường
        local tweenInfo = TweenInfo.new(dist / _G.Settings.TweenSpeed, Enum.EasingStyle.Linear)
        local tween = TweenService:Create(hrp, tweenInfo, {CFrame = targetCFrame})
        tween:Play()
        tween.Completed:Wait()
    end
end

-- // 5. UI INTERFACE //
local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local Window = Fluent:CreateWindow({
    Title = "Zeraa Hub [Full Bypass]",
    SubTitle = "Maru Anti-Ban & Helper",
    TabWidth = 160,
    Size = UDim2.fromOffset(580, 460),
    Theme = "Darker",
    MinimizeKey = Enum.KeyCode.End
})

local Tabs = {
    Main = Window:AddTab({ Title = "Race V4 / Trials" }),
    Train = Window:AddTab({ Title = "Auto Train V4" }),
    Settings = Window:AddTab({ Title = "Settings" })
}

-- // 6. CHỨC NĂNG CHI TIẾT //

-- [AUTO TRAIN V4 - TREO CỨNG]
local TrainPos = CFrame.new(-9240, 524, 5788)
local FarmPos = CFrame.new(-9513, 164, 5786)

Tabs.Train:AddToggle("AutoTrainV4", {
    Title = "Auto Train V4 (Safe Anchor)",
    Description = "Treo cứng, không rơi, giữ kết nối",
    Default = false,
    Callback = function(v) 
        _G.AutoTrainV4 = v
        if not v then
            local hrp = getHRP()
            if hrp then hrp.Anchored = false end
        end
    end
})

spawn(function()
    while task.wait() do
        if _G.AutoTrainV4 then
            pcall(function()
                local char = LocalPlayer.Character
                local hrp = getHRP()
                if not char or not hrp then return end

                local isTransformed = char:FindFirstChild("RaceTransformed")

                if isTransformed then
                    -- TRẠNG THÁI: ĐÃ BẬT TỘC -> NEO CỨNG VÀ SPAM SKILL
                    hrp.CFrame = TrainPos
                    hrp.Anchored = true -- Quan trọng: Giữ char không bị physics tác động
                    
                    if _G.Settings.SpamSkill and tick() % 2 == 0 then
                        EquipWeapon()
                        SendKey("Z")
                        task.wait(0.1)
                        SendKey("X")
                        task.wait(0.1)
                        SendKey("C") -- Spam thêm skill để chắc ăn
                    end
                else
                    -- TRẠNG THÁI: CHƯA BẬT TỘC -> ĐI FARM NỘ
                    hrp.Anchored = false
                    
                    local raceEnergy = LocalPlayer.PlayerGui.Main.RaceEnergy.Frame.Size.X.Scale
                    if raceEnergy >= 1 then
                        SendKey("Y") -- Nộ đầy thì bật
                    else
                        -- Tìm quái farm
                        local target = nil
                        for _, v in pairs(Workspace.Enemies:GetChildren()) do
                            if (v.Name == "Reborn Skeleton" or v.Name == "Living Zombie" or v.Name == "Demonic Soul") 
                               and v:FindFirstChild("Humanoid") and v.Humanoid.Health > 0 then
                                target = v
                                break
                            end
                        end

                        if target then
                            SmartMove(target.HumanoidRootPart.CFrame * CFrame.new(0, 5, 0))
                            EquipWeapon()
                            SafeAttack()
                        else
                            SmartMove(FarmPos)
                        end
                    end
                end
            end)
        end
    end
end)

-- [TRIALS & HELPER LOGIC]
local ToT_Center = CFrame.new(28282, 14896, -11)
local RaceDoors = {
    ["Human"] = CFrame.new(29221, 14890, -206),
    ["Skypiea"] = CFrame.new(28960, 14919, 235),
    ["Fishman"] = CFrame.new(28231, 14890, -211),
    ["Mink"] = CFrame.new(29012, 14890, -380),
    ["Ghoul"] = CFrame.new(28674, 14890, 445),
    ["Cyborg"] = CFrame.new(28502, 14895, -423)
}

Tabs.Main:AddToggle("AutoDoor", {Title = "Auto Go To Door", Default = false, Callback = function(v) _G.AutoDoor = v end})
Tabs.Main:AddToggle("AutoTrial", {Title = "Auto Complete Trial", Default = false, Callback = function(v) _G.AutoTrial = v end})
Tabs.Main:AddToggle("HelperMode", {Title = "HELPER: Follow & Sync V3/V4", Default = false, Callback = function(v) _G.HelperMode = v end})

-- [CƠ CHẾ HELPER - ĐỒNG BỘ BẬT TỘC]
spawn(function()
    while task.wait() do
        if _G.HelperMode then
            pcall(function()
                local mainPlr = Players:FindFirstChild(_G.Settings.MainAccount)
                local hrp = getHRP()
                
                if mainPlr and mainPlr.Character and mainPlr.Character:FindFirstChild("HumanoidRootPart") and hrp then
                    local mainPos = mainPlr.Character.HumanoidRootPart.Position
                    
                    -- Nếu acc chính đang ở khu vực Trial (ToT)
                    if mainPos.Y > 14000 then
                        local dist = (hrp.Position - mainPos).Magnitude
                        
                        -- 1. Bám đuôi acc chính
                        if dist > _G.Settings.HelperDistance then
                            SmartMove(mainPlr.Character.HumanoidRootPart.CFrame * CFrame.new(3, 0, 0))
                        else
                            -- 2. Logic Đồng Bộ Bật Tộc
                            -- Acc phụ sẽ spam bật tộc liên tục khi ở trong phòng trial
                            -- Điều này đảm bảo khi Main đếm 3-2-1 và bật, Helper cũng bật ngay lập tức
                            ReplicatedStorage.Remotes.CommE:FireServer("ActivateAbility") -- Kích hoạt V3
                            SendKey("T") -- Dự phòng phím T
                            SendKey("Y") -- Kích hoạt V4 nếu có
                        end
                    end
                else
                    if _G.Settings.MainAccount == "" or _G.Settings.MainAccount == "Ten_Nick_Chinh_Cua_Ban" then
                        Notify("Vui lòng điền tên Acc chính vào Settings!")
                        _G.HelperMode = false
                    end
                end
            end)
        end
    end
end)

-- [LOGIC AUTO TRIAL CHI TIẾT]
spawn(function()
    while task.wait() do
        if _G.AutoTrial then
            pcall(function()
                local race = LocalPlayer.Data.Race.Value
                local hrp = getHRP()
                if not hrp then return end

                -- TỘC HUMAN / GHOUL (GOM QUÁI & GIẾT)
                if race == "Human" or race == "Ghoul" then
                    for _, v in pairs(Workspace.Enemies:GetChildren()) do
                        if v:FindFirstChild("Humanoid") and v.Humanoid.Health > 0 then
                            local root = v.HumanoidRootPart
                            if (root.Position - hrp.Position).Magnitude < 1500 then
                                hrp.CFrame = root.CFrame * CFrame.new(0, 5, 0)
                                -- Gom nhẹ (không dùng tween để tránh lỗi)
                                root.CFrame = hrp.CFrame * CFrame.new(0, 0, -4)
                                root.CanCollide = false
                                SafeAttack()
                            end
                        end
                    end
                
                -- TỘC SHARK (FISHMAN) - BOSS SEABEAST
                elseif race == "Fishman" then
                    local target = nil
                    -- Tìm SeaBeast trong Workspace hoặc Folder enemies
                    for _, v in pairs(Workspace:GetDescendants()) do
                        if (v.Name == "SeaBeast" or v.Name == "Sea Beast") and v:FindFirstChild("Humanoid") and v.Humanoid.Health > 0 then
                            target = v
                            break
                        end
                    end
                    
                    if target then
                        SmartMove(target.HumanoidRootPart.CFrame * CFrame.new(0, 60, 0))
                        EquipWeapon()
                        -- Combo skill
                        SendKey("Z"); SendKey("X"); SendKey("C"); SendKey("V")
                        -- Đổi vũ khí spam
                        SendKey("1"); task.wait(0.1)
                        SendKey("2"); task.wait(0.1)
                    end

                -- TỘC MINK (CHẠY ĐUA)
                elseif race == "Mink" then
                    -- Tự động tìm các điểm Checkpoint/FinishPoint
                    for _,v in pairs(Workspace.Map:GetDescendants()) do
                        if v.Name == "FinishPoint" or v.Name == "Checkpoint" then 
                            SmartMove(v.CFrame) 
                        end
                    end
                
                -- TỘC SKY (NHẢY)
                elseif race == "Skypiea" then
                    local sky = Workspace.Map:FindFirstChild("SkyTrial")
                    if sky then
                        local endPart = sky.Model:FindFirstChild("snowisland_Cylinder.081") -- Điểm cuối
                        if endPart then
                            SmartMove(endPart.CFrame)
                        else
                            -- Nếu chưa load map, nhảy từng bước
                            for i=1, 25 do
                                local part = sky.Model:FindFirstChild("Part"..i)
                                if part then SmartMove(part.CFrame) end
                            end
                        end
                    end
                end
            end)
        end
    end
end)

-- [LOGIC AUTO DOOR]
spawn(function()
    while task.wait() do
        if _G.AutoDoor then
            pcall(function()
                local hrp = getHRP()
                if not hrp then return end
                
                if hrp.Position.Y < 12000 then
                    -- Load map lên ToT
                    ForceLoadMap(ToT_Center.Position)
                else
                    local race = LocalPlayer.Data.Race.Value
                    if RaceDoors[race] then
                        SmartMove(RaceDoors[race])
                    end
                end
            end)
        end
    end
end)

Notify("Script Loaded: Anti-Ban Maru Active!")
