--[[
    ZERAA HUB - RACE V4 SPECIALIZED [FULL VERSION]
    Support: Auto Train, Auto Trial, Helper Sync, Anti-Ban Maru
]]

-- // 1. CONFIGURATION //
getgenv().Config = {
    MainAccount = "", -- ĐIỀN TÊN ACC CHÍNH VÀO ĐÂY (NẾU DÙNG HELPER)
    TweenSpeed = 300,
    AutoGear = true,
    SpamSkill = true
}

-- // 2. LOAD UI LIBRARY (DÙNG ORION CHO ỔN ĐỊNH) //
local OrionLib = loadstring(game:HttpGet(('https://raw.githubusercontent.com/shlexware/Orion/main/source')))()
local Window = OrionLib:MakeWindow({Name = "Zeraa Hub | Race V4 Specialized", HidePremium = false, SaveConfig = true, ConfigFolder = "ZeraaV4"})

-- // 3. SERVICES & VARIABLES //
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")
local VirtualUser = game:GetService("VirtualUser")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

-- // 4. MARU ANTI-BAN (CHẠY NGẦM) //
task.spawn(function()
    while task.wait(15) do -- Gửi gói tin mỗi 15s để fake mobile/active
        pcall(function()
            local args = {
                {},
                false,
                "en-gb",
                "Mobile",
                Vector2.new(1600, 900),
                false,
                1
            }
            ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("OnEventServiceUpdate"):FireServer(unpack(args))
        end)
    end
end)

-- Anti AFK
LocalPlayer.Idled:Connect(function()
    VirtualUser:CaptureController()
    VirtualUser:Button2Down(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
    task.wait(1)
    VirtualUser:Button2Up(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
end)

-- // 5. CORE FUNCTIONS //

local function Notify(title, content)
    OrionLib:MakeNotification({
        Name = title,
        Content = content,
        Image = "rbxassetid://4483345998",
        Time = 5
    })
end

local function getHRP()
    return LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
end

local function EquipWeapon()
    pcall(function()
        for _, v in pairs(LocalPlayer.Backpack:GetChildren()) do
            if v:IsA("Tool") and v.ToolTip == "Melee" then
                LocalPlayer.Character.Humanoid:EquipTool(v)
            end
        end
    end)
end

local function SendKey(key)
    pcall(function()
        local vim = game:GetService("VirtualInputManager")
        vim:SendKeyEvent(true, Enum.KeyCode[key], false, game)
        task.wait(0.05)
        vim:SendKeyEvent(false, Enum.KeyCode[key], false, game)
    end)
end

local function SafeAttack()
    pcall(function()
        if LocalPlayer.Character then
            VirtualUser:CaptureController()
            VirtualUser:Button1Down(Vector2.new(1280, 672))
            -- Support dmg
            if ReplicatedStorage.Modules.Net:FindFirstChild("RegisterAttack") then
                ReplicatedStorage.Modules.Net.RegisterAttack:FireServer(0)
            end
        end
    end)
end

-- Fix Map Load (Chống rơi vực)
local function SmartMove(targetCFrame)
    local hrp = getHRP()
    if not hrp then return end

    -- Tắt va chạm
    for _, v in pairs(LocalPlayer.Character:GetDescendants()) do
        if v:IsA("BasePart") then v.CanCollide = false end
    end

    local dist = (hrp.Position - targetCFrame.Position).Magnitude
    
    -- Nếu xa > 2500 (Từ biển lên trời) -> Dùng Load Map Logic
    if dist > 2500 then
        -- Freeze
        hrp.Anchored = true
        hrp.CFrame = targetCFrame
        
        -- Spam request load
        for i = 1, 10 do
            LocalPlayer:RequestStreamAroundAsync(targetCFrame.Position)
            ReplicatedStorage.Remotes.CommF_:InvokeServer("requestEntrance", targetCFrame.Position)
            task.wait(0.1)
        end
        
        -- Chờ sàn nhà (Raycast)
        local loaded = false
        local t = 0
        repeat
            task.wait(0.5)
            t = t + 0.5
            local ray = Ray.new(hrp.Position, Vector3.new(0, -30, 0))
            local part, _ = Workspace:FindPartOnRay(ray, LocalPlayer.Character)
            if part then loaded = true end
        until loaded or t > 10
        
        hrp.Anchored = false
    else
        -- Bay thường
        local tweenInfo = TweenInfo.new(dist / getgenv().Config.TweenSpeed, Enum.EasingStyle.Linear)
        local tween = TweenService:Create(hrp, tweenInfo, {CFrame = targetCFrame})
        tween:Play()
        tween.Completed:Wait()
    end
end

-- // 6. TABS & LOGIC //

-- [TAB 1: MAIN - TRIAL & STATUS]
local MainTab = Window:MakeTab({Name = "Race V4 / Trials", Icon = "rbxassetid://4483345998", PremiumOnly = false})

MainTab:AddToggle({
    Name = "Auto Train V4 (Fixed Anchor)",
    Default = false,
    Callback = function(Value)
        getgenv().AutoTrain = Value
        if not Value then
            local hrp = getHRP()
            if hrp then hrp.Anchored = false end
        end
    end
})

MainTab:AddToggle({
    Name = "Auto Complete Trial (Full Race)",
    Default = false,
    Callback = function(Value)
        getgenv().AutoTrial = Value
    end
})

MainTab:AddToggle({
    Name = "Auto Gear (Pick Up)",
    Default = true,
    Callback = function(Value)
        getgenv().Config.AutoGear = Value
    end
})

-- [TAB 2: LOCATION - TELEPORT]
local LocTab = Window:MakeTab({Name = "Location / Door", Icon = "rbxassetid://4483345998", PremiumOnly = false})

LocTab:AddToggle({
    Name = "Auto Go To Door (Fix Map Load)",
    Default = false,
    Callback = function(Value)
        getgenv().AutoDoor = Value
    end
})

-- [TAB 3: HELPER - SYNC]
local HelperTab = Window:MakeTab({Name = "Helper Mode", Icon = "rbxassetid://4483345998", PremiumOnly = false})

HelperTab:AddTextbox({
    Name = "Main Account Name",
    Default = "",
    TextDisappear = false,
    Callback = function(Value)
        getgenv().Config.MainAccount = Value
    end
})

HelperTab:AddToggle({
    Name = "Helper: Follow & Sync V3/V4",
    Default = false,
    Callback = function(Value)
        getgenv().HelperMode = Value
    end
})

-- // 7. LOGIC LOOP IMPLEMENTATION //

-- LOGIC 1: AUTO TRAIN (NEO NGƯỜI)
local TrainPos = CFrame.new(-9240, 524, 5788)
local FarmPos = CFrame.new(-9513, 164, 5786)

task.spawn(function()
    while task.wait() do
        if getgenv().AutoTrain then
            pcall(function()
                local hrp = getHRP()
                if not hrp then return end
                local char = LocalPlayer.Character

                if char:FindFirstChild("RaceTransformed") then
                    -- ĐÃ BẬT TỘC: GIỮ VỊ TRÍ + SPAM SKILL
                    hrp.CFrame = TrainPos
                    hrp.Anchored = true -- Fix lỗi rơi/giật
                    
                    if tick() % 2 == 0 then
                        EquipWeapon()
                        SendKey("Z")
                        task.wait(0.2)
                        SendKey("X")
                    end
                else
                    -- CHƯA BẬT: FARM NỘ
                    hrp.Anchored = false
                    local energy = LocalPlayer.PlayerGui.Main.RaceEnergy.Frame.Size.X.Scale
                    if energy >= 1 then
                        SendKey("Y")
                    else
                        -- Tìm quái
                        local target = nil
                        for _, v in pairs(Workspace.Enemies:GetChildren()) do
                            if (v.Name == "Reborn Skeleton" or v.Name == "Living Zombie") and v:FindFirstChild("Humanoid") and v.Humanoid.Health > 0 then
                                target = v
                                break
                            end
                        end
                        
                        if target then
                            SmartMove(target.HumanoidRootPart.CFrame * CFrame.new(0, 5, 0))
                            EquipWeapon()
                            SafeAttack()
                        else
                            SmartMove(FarmPos)
                        end
                    end
                end
            end)
        end
    end
end)

-- LOGIC 2: HELPER (ĐỒNG BỘ)
task.spawn(function()
    while task.wait(0.5) do
        if getgenv().HelperMode and getgenv().Config.MainAccount ~= "" then
            pcall(function()
                local mainUser = Players:FindFirstChild(getgenv().Config.MainAccount)
                local hrp = getHRP()
                
                if mainUser and mainUser.Character and hrp then
                    local mainPos = mainUser.Character.HumanoidRootPart.Position
                    
                    -- Nếu Main đang ở Trial (ToT)
                    if mainPos.Y > 14000 then
                        local dist = (hrp.Position - mainPos).Magnitude
                        if dist > 15 then
                            SmartMove(mainUser.Character.HumanoidRootPart.CFrame * CFrame.new(3, 0, 3))
                        else
                            -- Ở gần -> Spam bật tộc để đồng bộ
                            ReplicatedStorage.Remotes.CommE:FireServer("ActivateAbility")
                            SendKey("T")
                            SendKey("Y")
                        end
                    end
                end
            end)
        end
    end
end)

-- LOGIC 3: AUTO TRIAL (CHI TIẾT TỪNG TỘC)
task.spawn(function()
    while task.wait() do
        if getgenv().AutoTrial then
            pcall(function()
                local race = LocalPlayer.Data.Race.Value
                local hrp = getHRP()
                if not hrp then return end

                -- [MINK] - Chạy
                if race == "Mink" then
                    for _, v in pairs(Workspace.Map:GetDescendants()) do
                        if v.Name == "FinishPoint" or v.Name == "Checkpoint" then
                            SmartMove(v.CFrame)
                        end
                    end
                
                -- [SKY] - Nhảy
                elseif race == "Skypiea" then
                    local sky = Workspace.Map:FindFirstChild("SkyTrial")
                    if sky then
                        -- Ưu tiên đích đến
                        local finish = sky.Model:FindFirstChild("snowisland_Cylinder.081")
                        if finish then
                            SmartMove(finish.CFrame)
                        else
                            -- Nhảy từng bậc
                            for i=1, 20 do
                                local p = sky.Model:FindFirstChild("Part"..i)
                                if p then SmartMove(p.CFrame) end
                            end
                        end
                    end

                -- [FISHMAN] - Giết SeaBeast
                elseif race == "Fishman" then
                    local sb = nil
                    for _,v in pairs(Workspace:GetDescendants()) do
                        if v.Name == "SeaBeast" and v:FindFirstChild("Humanoid") then
                            sb = v
                            break
                        end
                    end
                    if sb then
                        SmartMove(sb.HumanoidRootPart.CFrame * CFrame.new(0, 50, 0))
                        EquipWeapon()
                        SendKey("Z"); SendKey("X"); SendKey("C"); SendKey("V")
                    end

                -- [HUMAN / GHOUL] - Giết quái
                elseif race == "Human" or race == "Ghoul" then
                    for _, v in pairs(Workspace.Enemies:GetChildren()) do
                        if v:FindFirstChild("Humanoid") and v.Humanoid.Health > 0 then
                            local eh = v.HumanoidRootPart
                            if (eh.Position - hrp.Position).Magnitude < 2000 then
                                hrp.CFrame = eh.CFrame * CFrame.new(0, 5, 0)
                                eh.CFrame = hrp.CFrame * CFrame.new(0, 0, -4)
                                eh.CanCollide = false
                                SafeAttack()
                            end
                        end
                    end
                
                -- [CYBORG] - Né bom (Thực ra là treo)
                elseif race == "Cyborg" then
                    -- Cyborg trial là né, chỉ cần bay lên cao hoặc đứng im chỗ an toàn
                    -- Script này sẽ TP về giữa để tránh bị rơi
                    if (hrp.Position - Vector3.new(28282, 14896, -11)).Magnitude > 300 then
                        SmartMove(CFrame.new(28282, 14896, -11))
                    end
                end
            end)
        end
    end
end)

-- LOGIC 4: AUTO GEAR (NHẶT BÁNH RĂNG)
task.spawn(function()
    while task.wait(1) do
        if getgenv().Config.AutoGear then
            pcall(function()
                -- Gear thường là một Part hoặc MeshPart xuất hiện sau trial
                -- Logic đơn giản nhất là check comms
                ReplicatedStorage.Remotes.CommF_:InvokeServer("UpgradeRace", "Buy")
            end)
        end
    end
end)

-- LOGIC 5: AUTO DOOR (MAP LOAD)
local ToT_Center = CFrame.new(28282, 14896, -11)
local RaceDoors = {
    ["Human"] = CFrame.new(29221, 14890, -206),
    ["Skypiea"] = CFrame.new(28960, 14919, 235),
    ["Fishman"] = CFrame.new(28231, 14890, -211),
    ["Mink"] = CFrame.new(29012, 14890, -380),
    ["Ghoul"] = CFrame.new(28674, 14890, 445),
    ["Cyborg"] = CFrame.new(28502, 14895, -423)
}

task.spawn(function()
    while task.wait() do
        if getgenv().AutoDoor then
            pcall(function()
                local hrp = getHRP()
                if not hrp then return end
                
                if hrp.Position.Y < 12000 then
                    -- Đang ở dưới biển -> Lên trời (Cần load map)
                    SmartMove(ToT_Center)
                else
                    -- Đã ở trên trời -> Tìm cửa
                    local race = LocalPlayer.Data.Race.Value
                    if RaceDoors[race] then
                        SmartMove(RaceDoors[race])
                    end
                end
            end)
        end
    end
end)

Notify("Zeraa Hub", "Script Loaded Successfully!")
