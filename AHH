--[[
    ‚ñà‚ñÄ‚ñÑ‚ñÄ‚ñà ‚ñà‚ñÄ‚ñÄ ‚ñà‚ñÄ‚ñÄ‚ñÄ ‚ñà‚ñÄ‚ñÄ ‚ñà‚ñë‚ñà ‚ñà‚ñÄ‚ñÄ‚ñÑ ‚ñà‚ñÄ‚ñÄ ‚ñà‚ñÄ‚ñÄ‚ñÄ
    ‚ñà‚ñë‚ñÄ‚ñë‚ñà ‚ñà‚ñÄ‚ñÄ ‚ñà‚ñë‚ñÄ‚ñÑ ‚ñà‚ñÄ‚ñÄ ‚ñà‚ñÄ‚ñÑ ‚ñà‚ñë‚ñë‚ñà ‚ñà‚ñÄ‚ñÄ ‚ñÄ‚ñÄ‚ñÄ‚ñà
    ‚ñÄ‚ñë‚ñë‚ñë‚ñÄ ‚ñÄ‚ñÄ‚ñÄ ‚ñÄ‚ñÄ‚ñÄ‚ñÄ ‚ñÄ‚ñë‚ñë ‚ñÄ‚ñë‚ñÄ ‚ñÄ‚ñÄ‚ñÄ‚ñë ‚ñÄ‚ñÄ‚ñÄ ‚ñÄ‚ñÄ‚ñÄ‚ñÄ
    AUTO V4 A-Z (PREMIUM EDITION)
    Logic: RedzHub Fake (Tween/FastAttack) + BananaCat (Trial/Gear)
    UI: Fluent
]]

--// 1. C·∫§U H√åNH (CONFIG)
getgenv().ConfigV4 = {
    ["Account Up Gear"] = {
        "UserMain1" -- T√™n ƒëƒÉng nh·∫≠p Acc Ch√≠nh
    },
    ["Account Help"] = {
        "UserHelp1", "UserHelp2" -- T√™n ƒëƒÉng nh·∫≠p Acc Ph·ª•
    },
    ["Auto Join"] = true,
    ["Webhook"] = {
        ["url"] = "", -- D√°n Webhook Discord
        ["Done Train"] = false, -- True: ƒê√£ train xong, False: Ch∆∞a train (S·∫Ω ƒëi farm bone)
        ["Done Trial"] = false,
        ["Tiers"] = "1-10",
        ["ChooseGear"] = "Red, Red, Blue",
    }
}
getgenv().AccountFindFullMoon = "" -- T√™n acc t√¨m trƒÉng

--// GLOBAL TOGGLES
getgenv().AutoFarmBone = false -- M·∫∑c ƒë·ªãnh t·∫Øt, b·∫≠t qua UI
getgenv().AutoV4Loop = true

--// 2. KH·ªûI T·∫†O UI (FLUENT + BACKUP)
local Fluent = nil
local success, result = pcall(function()
    return loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
end)

if success and result then
    Fluent = result
else
    local success2, result2 = pcall(function()
        return loadstring(game:HttpGet("https://raw.githubusercontent.com/Complexita/Fluent/master/main.lua"))()
    end)
    if success2 and result2 then
        Fluent = result2
    else
        warn("CRITICAL: Kh√¥ng th·ªÉ load UI Fluent.")
        return
    end
end

--// 3. SERVICES & VARIABLES
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local TweenService = game:GetService("TweenService")
local VirtualUser = game:GetService("VirtualUser")
local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")
local Lighting = game:GetService("Lighting")

local LP = Players.LocalPlayer
local Mouse = LP:GetMouse()

-- [T·ªça ƒë·ªô]
local V4_Door_Coords = {
    ["Human"] = CFrame.new(29221, 14890, -205),
    ["Skypiea"] = CFrame.new(28960, 14919, 235),
    ["Fishman"] = CFrame.new(28231, 14890, -211),
    ["Cyborg"] = CFrame.new(28502, 14895, -423),
    ["Ghoul"] = CFrame.new(28674, 14890, 445),
    ["Mink"] = CFrame.new(29012, 14890, -380)
}
local ToT_CFrame = CFrame.new(28286, 14897, 103) -- Temple of Time Main
local AncientClock_CFrame = CFrame.new(28286, 14897, 103) 
local Lever_CFrame = CFrame.new(28456, 14903, 7)
local Train_Mob_CFrame = CFrame.new(-9508, 142, 5737) -- Haunted Castle

--// 4. FIX LAG & BYPASS (30s LOOP)
local FixLagArgs = {
    {},
    false,
    "en-gb",
    "Mobile",
    Vector2.new(1600, 900),
    false,
    1
}

task.spawn(function()
    while true do
        pcall(function()
            -- G·ªçi remote load map/fix lag
            ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("OnEventServiceUpdate"):FireServer(unpack(FixLagArgs))
        end)
        task.wait(30)
    end
end)

--// 5. ANTI-BAN SYSTEM
local function InitAntiBan()
    local mt = getrawmetatable(game)
    local old = mt.__namecall
    setreadonly(mt, false)
    mt.__namecall = newcclosure(function(self, ...)
        local method = getnamecallmethod()
        local args = {...}
        if method == "FireServer" and self.Name == "MainEvent" and table.find({"CHECK", "One", "TeleportDetect", "Kick"}, args[1]) then
            return
        end
        return old(self, ...)
    end)
    setreadonly(mt, true)

    Players.PlayerAdded:Connect(function(plr)
        if plr:IsInGroup(1200769) or plr.UserId == 1 or plr:GetRankInGroup(4372130) > 10 then
            LP:Kick("Anti-Ban: Admin Detected.")
        end
    end)
end
InitAntiBan()

--// 6. HELPER FUNCTIONS

-- [Fast Attack - RedzHubFake]
function FastAttack()
    local CombatFramework = require(LP.PlayerScripts.CombatFramework)
    local CameraShaker = require(LP.PlayerScripts.CombatFramework.CameraShaker)
    
    CameraShaker.CameraShakeInstance.CameraShakeState = {FadingIn = 3, FadingOut = 2, Sustained = 0, Inactive = 1}
    
    task.spawn(function()
        pcall(function()
            if LP.Character and LP.Character:FindFirstChild("Humanoid") and LP.Character.Humanoid.Health > 0 then
                if CombatFramework.activeController then
                    CombatFramework.activeController.timeToNextAttack = 0
                    CombatFramework.activeController.hitboxMagnitude = 60
                    CombatFramework.activeController.increment = 3
                end
                VirtualUser:CaptureController()
                VirtualUser:Button1Down(Vector2.new(1280, 672))
            end
        end)
    end)
end

function EquipWeapon()
    pcall(function()
        for _, v in pairs(LP.Backpack:GetChildren()) do
            if v:IsA("Tool") and v.ToolTip == "Melee" then
                LP.Character.Humanoid:EquipTool(v)
            end
        end
    end)
end

function CheckRace()
    return LP.Data.Race.Value
end

function SendWebhook(msg)
    if not getgenv().ConfigV4.Webhook.url or getgenv().ConfigV4.Webhook.url == "" then return end
    local data = {
        ["content"] = "",
        ["embeds"] = {{
            ["title"] = "üî• Blox Fruits Auto V4 üî•",
            ["description"] = "User: **" .. LP.Name .. "**\nAction: " .. msg,
            ["color"] = 16711680
        }}
    }
    request({Url = getgenv().ConfigV4.Webhook.url, Body = HttpService:JSONEncode(data), Method = "POST", Headers = {["content-type"] = "application/json"}})
end

-- [Tween System - RedzHubFake Logic with OnEventServiceUpdate]
function Tween(targetCF)
    if not LP.Character or not LP.Character:FindFirstChild("HumanoidRootPart") then return end
    
    -- X·ª≠ l√Ω ƒë·∫∑c bi·ªát khi ƒë·∫øn Temple of Time ƒë·ªÉ Load Map
    local distToToT = (targetCF.Position - ToT_CFrame.Position).Magnitude
    if distToToT < 3000 then -- N·∫øu ƒë√≠ch ƒë·∫øn n·∫±m trong khu v·ª±c Temple of Time
        pcall(function()
            -- G·ªçi Remote Load Map
            ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("OnEventServiceUpdate"):FireServer(unpack(FixLagArgs))
            -- G·ªçi Stream Update
            LP.ReplicatedFirst:WaitForChild("RequestStreamAroundAsync"):InvokeServer(targetCF.Position)
        end)
    end

    local distance = (LP.Character.HumanoidRootPart.Position - targetCF.Position).Magnitude
    local speed = 300
    local info = TweenInfo.new(distance / speed, Enum.EasingStyle.Linear)
    local tween = TweenService:Create(LP.Character.HumanoidRootPart, info, {CFrame = targetCF})
    
    -- Noclip
    local noclip = RunService.Stepped:Connect(function()
        if LP.Character then
            for _, v in pairs(LP.Character:GetDescendants()) do
                if v:IsA("BasePart") and v.CanCollide then v.CanCollide = false end
            end
        end
    end)
    
    tween:Play()
    tween.Completed:Wait()
    if noclip then noclip:Disconnect() end
end

--// 7. AUTO TRAIN / FARM BONE (BananaCat Logic)
-- H√†m n√†y s·∫Ω ƒë∆∞·ª£c qu·∫£n l√Ω b·ªüi Toggle trong UI
function AutoTrainMobLogic()
    local EnemyName = "Reborn Skeleton" -- Haunted Castle Mob
    
    -- Di chuy·ªÉn ƒë·∫øn ƒë·∫£o train n·∫øu xa
    if (LP.Character.HumanoidRootPart.Position - Train_Mob_CFrame.Position).Magnitude > 2000 then
        Tween(Train_Mob_CFrame)
    end
    
    task.spawn(function()
        while getgenv().AutoFarmBone do
            pcall(function()
                local mobs = Workspace.Enemies:GetChildren()
                for _, v in pairs(mobs) do
                    if v.Name == EnemyName and v:FindFirstChild("HumanoidRootPart") and v.Humanoid.Health > 0 and getgenv().AutoFarmBone then
                        repeat
                            if not LP.Character or not LP.Character:FindFirstChild("HumanoidRootPart") then break end
                            
                            EquipWeapon()
                            
                            -- Gom qu√°i & ƒê√°nh (BananaCat Logic)
                            v.HumanoidRootPart.CanCollide = false
                            v.HumanoidRootPart.Size = Vector3.new(60, 60, 60)
                            v.HumanoidRootPart.CFrame = LP.Character.HumanoidRootPart.CFrame * CFrame.new(0, 0, -4)
                            
                            FastAttack()
                            
                            -- S·ª≠ d·ª•ng Skill Z, X (Melee)
                            VirtualUser:TypeKey(Enum.KeyCode.Z)
                            VirtualUser:TypeKey(Enum.KeyCode.X)
                            
                            RunService.Heartbeat:Wait()
                        until v.Humanoid.Health <= 0 or not v.Parent or not getgenv().AutoFarmBone
                    end
                end
                
                -- N·∫øu kh√¥ng th·∫•y qu√°i, quay v·ªÅ ƒëi·ªÉm spawn
                if (LP.Character.HumanoidRootPart.Position - Train_Mob_CFrame.Position).Magnitude > 500 then
                    Tween(Train_Mob_CFrame)
                end
            end)
            task.wait(0.1)
        end
    end)
end

--// 8. AUTO TRIAL & PVP & GEAR (BananaCat Logic)

function BuyGear()
    local args = "Buy"
    ReplicatedStorage.Remotes.CommF_:InvokeServer("UpgradeRace", args)
    SendWebhook("Bought/Upgraded Gear Successful!")
end

function ChooseGear()
    -- Logic ch·ªçn Gear: Bay l√™n ƒë·ªìng h·ªì, click, r·ªìi mua
    Tween(AncientClock_CFrame)
    task.wait(1)
    if Workspace.Map:FindFirstChild("TempleOfTime") and Workspace.Map.TempleOfTime:FindFirstChild("AncientClock") then
        fireclickdetector(Workspace.Map.TempleOfTime.AncientClock.ClickDetector)
    end
    task.wait(2)
    BuyGear()
end

function KillPlayersInTrial()
    task.spawn(function()
        while true do
            -- Ch·ªâ ch·∫°y khi ƒëang ·ªü trong Trial (G·∫ßn ToT)
            if (LP.Character.HumanoidRootPart.Position - ToT_CFrame.Position).Magnitude < 2000 then
                 for _, plr in pairs(Players:GetPlayers()) do
                    if plr ~= LP and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
                        -- Check kho·∫£ng c√°ch (ƒêang pvp trong trial)
                        if (plr.Character.HumanoidRootPart.Position - LP.Character.HumanoidRootPart.Position).Magnitude < 1000 then
                            
                            -- Ki·ªÉm tra xem c√≥ ph·∫£i acc Help kh√¥ng
                            local isHelper = false
                            for _, helpName in pairs(getgenv().ConfigV4["Account Help"]) do
                                if plr.Name == helpName then isHelper = true end
                            end
                            
                            if not isHelper then
                                -- Kill enemy logic
                                pcall(function()
                                    Tween(plr.Character.HumanoidRootPart.CFrame * CFrame.new(0, 4, 0))
                                    EquipWeapon()
                                    FastAttack()
                                    VirtualUser:TypeKey(Enum.KeyCode.Z)
                                    VirtualUser:TypeKey(Enum.KeyCode.X)
                                    VirtualUser:TypeKey(Enum.KeyCode.C)
                                    VirtualUser:TypeKey(Enum.KeyCode.V)
                                end)
                            end
                        end
                    end
                end
            end
            task.wait(0.1)
        end
    end)
end

function StartTrialLoop()
    task.spawn(function()
        while getgenv().AutoV4Loop do
            pcall(function()
                -- 1. Check ƒëi·ªÅu ki·ªán (Full Moon check b·ªè qua, gi·∫£ s·ª≠ ƒë√£ t√¨m ƒë∆∞·ª£c server)
                
                -- 2. Bay ƒë·∫øn c·ª≠a Trial (Redz Coords)
                local race = CheckRace()
                local doorCF = V4_Door_Coords[race]
                
                if doorCF then
                    if (LP.Character.HumanoidRootPart.Position - ToT_CFrame.Position).Magnitude > 3000 then
                        Tween(ToT_CFrame) -- Bay ƒë·∫øn ToT ƒë·ªÉ load map tr∆∞·ªõc
                        task.wait(1)
                    end
                    
                    Tween(doorCF)
                    
                    -- Spam T·ªôc ƒë·ªÉ m·ªü c·ª≠a
                    if (LP.Character.HumanoidRootPart.Position - doorCF.Position).Magnitude < 50 then
                        ReplicatedStorage.Remotes.CommE:FireServer("ActivateAbility")
                    end
                end
                
                -- 3. X·ª≠ l√Ω khi Trial b·∫Øt ƒë·∫ßu
                -- Check n·∫øu map trial load (D·ª±a v√†o Workspace) ho·∫∑c kho·∫£ng c√°ch ƒë·∫øn ToT
                if (LP.Character.HumanoidRootPart.Position - ToT_CFrame.Position).Magnitude < 2000 then
                    -- Ki·ªÉm tra xem l√† Main hay Help
                    local isMain = false
                    for _, name in pairs(getgenv().ConfigV4["Account Up Gear"]) do
                        if LP.Name == name then isMain = true end
                    end
                    
                    if isMain then
                        -- Acc ch√≠nh: Kill Player
                        KillPlayersInTrial()
                        
                        -- N·∫øu th·∫Øng -> Bay l√™n ƒë·ªìng h·ªì -> Mua Gear
                        if (LP.Character.HumanoidRootPart.Position - AncientClock_CFrame.Position).Magnitude < 500 then
                            ChooseGear()
                        end
                    else
                        -- Acc ph·ª• (Help): Reset khi Trial b·∫Øt ƒë·∫ßu ƒë·ªÉ acc ch√≠nh win
                        -- ƒê∆°n gi·∫£n h√≥a: Ch·ªù 1 ch√∫t r·ªìi reset
                         if (LP.Character.HumanoidRootPart.Position - ToT_CFrame.Position).Magnitude < 1500 then
                             task.wait(8) -- Ch·ªù trial load xong
                             LP.Character.Humanoid.Health = 0
                         end
                    end
                end
            end)
            task.wait(1)
        end
    end)
end

--// 9. UI INITIALIZATION (FLUENT)

local Window = Fluent:CreateWindow({
    Title = "Auto V4 A-Z (Fix Lag + ToT Load)",
    SubTitle = "Complete Edition",
    TabWidth = 160,
    Size = UDim2.fromOffset(580, 460),
    Acrylic = true,
    Theme = "Dark",
    MinimizeKey = Enum.KeyCode.LeftControl
})

local Tabs = {
    Main = Window:AddTab({ Title = "General", Icon = "home" }),
    Settings = Window:AddTab({ Title = "Settings", Icon = "settings" })
}

-- [MAIN TAB]
local Role = "Unknown"
for _, n in pairs(getgenv().ConfigV4["Account Up Gear"]) do if LP.Name == n then Role = "Up Gear" end end
for _, n in pairs(getgenv().ConfigV4["Account Help"]) do if LP.Name == n then Role = "Helper" end end
if LP.Name == getgenv().AccountFindFullMoon then Role = "Finder" end

Tabs.Main:AddParagraph({
    Title = "Account Status",
    Content = "Role: " .. Role .. "\nAnti-Ban: Active\nFix Lag: Active (30s)"
})

-- Toggle Auto Farm Bone
local BoneToggle = Tabs.Main:AddToggle("AutoBone", {Title = "Auto Farm Bone (Training)", Default = false })
BoneToggle:OnChanged(function()
    getgenv().AutoFarmBone = BoneToggle.Value
    if getgenv().AutoFarmBone then
        AutoTrainMobLogic()
    end
end)

-- Toggle Auto V4
local V4Toggle = Tabs.Main:AddToggle("AutoV4", {Title = "Auto V4 Loop (Trial/Gear)", Default = true })
V4Toggle:OnChanged(function()
    getgenv().AutoV4Loop = V4Toggle.Value
end)

Tabs.Main:AddButton({
    Title = "Manual Buy Gear",
    Description = "TP to Clock & Buy",
    Callback = function()
        ChooseGear()
    end
})

-- [SETTINGS TAB]
Tabs.Settings:AddButton({
    Title = "Test Webhook",
    Callback = function()
        SendWebhook("Test Message Success!")
    end
})

Window:SelectTab(1)
Fluent:Notify({
    Title = "Script Loaded",
    Content = "Auto V4 A-Z has been initialized.",
    Duration = 5
})

--// 10. AUTO EXECUTE LOGIC (T·ª± ƒë·ªông ch·∫°y d·ª±a tr√™n config)

if Role == "Up Gear" then
    -- N·∫øu Config n√≥i ch∆∞a xong Train, t·ª± b·∫≠t Farm Bone
    if getgenv().ConfigV4.Webhook["Done Train"] == false then
        BoneToggle:SetValue(true)
    else
        StartTrialLoop()
    end
elseif Role == "Helper" then
    -- Acc Helper ch·ªâ ch·∫°y Trial Loop ƒë·ªÉ h·ªó tr·ª£ m·ªü c·ª≠a v√† reset
    StartTrialLoop()
elseif Role == "Finder" then
    -- Logic t√¨m trƒÉng (Server Hop n·∫øu kh√¥ng c√≥ trƒÉng)
    if Lighting.Sky.MoonTextureId == "http://www.roblox.com/asset/?id=9709149431" then
        SendWebhook("FULL MOON FOUND!")
    else
        -- Server Hop
        local module = loadstring(game:HttpGet"https://raw.githubusercontent.com/LeoKholYt/roblox/main/mi_server_hop.lua")()
        module:Teleport()
    end
end

-- Auto Rejoin
if getgenv().ConfigV4["Auto Join"] then
    game.CoreGui.RobloxPromptGui.promptOverlay.ChildAdded:Connect(function(child)
        if child.Name == 'ErrorPrompt' and child:FindFirstChild('MessageArea') and child.MessageArea:FindFirstChild("ErrorFrame") then
            game:GetService("TeleportService"):Teleport(game.PlaceId)
        end
    end)
end
